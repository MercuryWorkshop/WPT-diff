name: "WPT-diff Test Runner"
description: "Run Web Platform Tests against a web proxy with sharding support, standard WPT reports, failed test collection, and regression checking"
author: "MercuryWorkshop"
inputs:
  location:
    description: "Action clone location"
    required: true
  run_js_setup:
    description: "Whether to run node/pnpm setup"
    required: false
    default: true
  artifact_name:
    description: "Report artifact name"
    required: false
    default: "wpt-report"
  debug:
    description: ""
    required: false
    default: false
  verbose:
    description: ""
    required: false
    default: false
  wpt_max_tests:
    description: "Maximum number of WPT tests to run"
    required: false
    default: "all"
  under_proxy:
    description: "Run tests under proxy"
    required: false
    default: true
  proxy_base_url:
    description: "Base URL for WPT tests"
    required: false
    default: "http://localhost:1337/"
  wpt_tests_base_url:
    description: "Base URL for WPT tests"
    required: false
    default: "http://web-platform.test:8000"
  wpt_api_base_url:
    description: "Base URL for WPT API"
    required: false
    default: "https://wpt.fyi"
  shard_index:
    description: "Current shard index for splitting tests"
    required: false
    default: "0"
  total_shards:
    description: "Total number of shards for splitting tests"
    required: false
    default: "1"
  enable_regression_check:
    description: "Whether to run regression check against previous workflow results"
    required: false
    default: false
  github_repository:
    description: "GitHub repository for regression check"
    required: false
    default: ""
  github_token:
    description: "GitHub token for accessing previous workflow artifacts"
    required: false
    default: ""
  regression_check_workflow_name:
    description: "Workflow name to filter when looking for previous runs"
    required: false
    default: "WPT-diff Tests"

runs:
  using: "composite"
  steps:
    - name: Checkout WPT
      uses: actions/checkout@v4
      with:
        repository: web-platform-tests/wpt
        path: ${{ inputs.location }}/wpt
        ref: main
        fetch-depth: 1

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      if: ${{ inputs.run_js_setup }}
      with:
        version: latest

    - name: Setup Node.js with cache
      uses: actions/setup-node@v4
      if: ${{ inputs.run_js_setup }}
      with:
        node-version: latest
        cache: pnpm
        cache-dependency-path: ${{ inputs.location }}/pnpm-lock.yaml

    - name: Install WPT-diff dependencies
      shell: bash
      working-directory: ${{ inputs.location }}
      run: pnpm install

    # Combine and regression check
    - name: Download shard results
      uses: actions/download-artifact@v4
      with:
        pattern: wpt-shard-results-*
        path: ./shard-results

    - name: Combine reports
      shell: bash
      working-directory: ${{ inputs.location }}
      run: pnpm combine-reports ../shard-results ../final-reports

    - name: Run regression check
      if: ${{ inputs.github_token != '' && inputs.github_repository != '' }}
      shell: bash
      working-directory: ${{ inputs.location }}
      run: |
        pnpm regression-check \
          "${{ inputs.github_repository }}" \
          "${{ inputs.github_token }}" \
          "../final-reports/failed-tests.json" \
          "../final-reports/regression-fails.json" \
          "${{ inputs.regression_check_workflow_name }}"

    - name: Upload final reports
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact_name }}
        path: final-reports/
        retention-days: 90
