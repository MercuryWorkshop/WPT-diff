name: 'WPT-diff Test Runner'
description: 'Run Web Platform Tests against a proxy and collect failed results'
author: 'MercuryWorkshop'
inputs:
  location:
    description: 'Action clone location'
    required: true
  run_js_setup:
    description: 'Whether to run node/pnpm setup'
    required: false
    default: true
  artifact_name:
    description: 'Report artifact name'
    required: false
    default: "wpt-report"
  debug:
    description: ''
    required: false
    default: false
  verbose:
    description: ''
    required: false
    default: false
  wpt_max_tests:
    description: 'Maximum number of WPT tests to run'
    required: false
    default: 'all'
  under_proxy:
    description: 'Run tests under proxy'
    required: false
    default: true
  proxy_base_url:
    description: 'Base URL for WPT tests'
    required: false
    default: 'http://localhost:1337/'
  wpt_tests_base_url:
    description: 'Base URL for WPT tests'
    required: false
    default: 'http://web-platform.test:8000'
  wpt_api_base_url:
    description: 'Base URL for WPT API'
    required: false
    default: 'https://wpt.fyi'

runs:
  using: 'composite'
  steps:
    - name: Checkout WPT
      uses: actions/checkout@v4
      with:
        repository: web-platform-tests/wpt
        path: '${{ inputs.location }}/wpt'
        submodules: recursive

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      if: '${{ inputs.run_js_setup }}'
      with:
        version: latest

    - name: Setup Node.js
      uses: actions/setup-node@v4
      if: '${{ inputs.run_js_setup }}'
      with:
        node-version: latest
        cache: pnpm

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Setup WPT hosts
      shell: bash
      working-directory: '${{ inputs.location }}/wpt'
      run: |
        ./wpt make-hosts-file | sudo tee -a /etc/hosts

    - name: Install WPT-diff dependencies
      shell: bash
      working-directory: '${{ inputs.location }}'
      run: |
        pnpm install
        pnpm exec playwright install chromium

    - name: Start WPT server
      shell: bash
      working-directory: '${{ inputs.location }}/wpt'
      run: |
        ./wpt serve --no-h2 &
        WPT_PID=$!
        echo "WPT_PID=$WPT_PID" >> $GITHUB_ENV
        sleep 10

    - name: Create WPT-Diff config
      shell: bash
      working-directory: '${{ inputs.location }}'
      run: |
        cat > config.toml << EOF
        [debug]
        debug = ${{ inputs.debug }}
        verbose = ${{ inputs.verbose }}

        [wpt]
        max_tests = "${{ inputs.wpt_max_tests }}"
        under_proxy = ${{ inputs.under_proxy }}

        [wpt.urls]
        proxy_base_url = "${{ inputs.proxy_base_url }}"
        tests_base_url = "${{ inputs.wpt_tests_base_url }}"
        api_base_url = "${{ inputs.wpt_api_base_url }}"
        EOF

    - name: Run WPT-Diff tests
      uses: coactions/setup-xvfb@v1
      with:
        working-directory: '${{ inputs.location }}'
        run: |
          xvfb-run pnpm start --report wpt-report.json

    - name: Stop WPT server
      shell: bash
      working-directory: '${{ inputs.location }}'
      run: |
        if [ ! -z "$WPT_PID" ]; then
          kill $WPT_PID || true
        fi

    - name: Upload WPT standard report
      uses: actions/upload-artifact@v4
      with:
        name: '${{ inputs.artifact_name }}'
        path: '${{ inputs.location }}/wpt-report.json'
